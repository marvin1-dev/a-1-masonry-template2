<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A-1 Masonry offers expert construction and maintenance solutions." />
  <meta name="keywords" content="Construction, Masonry, Maintenance, Safety, Consultation" />
  <meta name="author" content="A-1 Masonry" />
  <title>A-1 Masonry | Expert Construction & Maintenance Services</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <h1>A-1 Masonry</h1>
  <nav>
    <a href="#services">Services</a>
    <a href="#about">About</a>
    <a href="#contact">Contact</a>
    <a href="#book" class="btn">Book now</a>
  </nav>
</header>

<section class="hero">
  <div class="hero-content">
    <h2>Expert Construction and Maintenance Solutions</h2>
  </div>
</section>

<section class="section" id="products">
  <div class="container">
    <h3>Featured Products</h3>
    <div class="card-container">
      <div class="card circle">
        <img src="https://picsum.photos/300/300?random=1" alt="Precision Build Services">
        <h4>Precision Build Services</h4>
        <p>$25</p>
      </div>
      <div class="card circle">
        <img src="https://picsum.photos/300/300?random=2" alt="24/7 Support Hub">
        <h4>24/7 Support Hub</h4>
        <p>$25</p>
      </div>
      <div class="card circle">
        <img src="https://picsum.photos/300/300?random=3" alt="SafeGuard Pro">
        <h4>SafeGuard Pro</h4>
        <p>$25</p>
      </div>
    </div>
    <div class="btn-wrapper">
      <a href="#services" class="btn">Shop All</a>
    </div>
  </div>
</section>

<section class="section" id="services">
  <div class="container">
    <h3>Our Services</h3>
    <div class="card-container">
      <div class="card">
        <img src="https://picsum.photos/600/400?random=4" alt="Precision Build Solutions">
        <h4>Precision Build Solutions</h4>
        <p>$99</p>
        <p>Delivering top-tier construction management and maintenance services.</p>
      </div>
      <div class="card">
        <img src="https://picsum.photos/600/400?random=5" alt="Expert Consultation">
        <h4>Expert Consultation</h4>
        <p>$149</p>
        <p>Personalized guidance and innovative solutions.</p>
      </div>
      <div class="card">
        <img src="https://picsum.photos/600/400?random=6" alt="Secure Build Compliance">
        <h4>Secure Build Compliance</h4>
        <p>$199</p>
        <p>Ensuring every project meets stringent safety standards.</p>
      </div>
    </div>
    <a href="#book" class="btn">Schedule Your Appointment</a>
  </div>
</section>

<section class="section" id="book">
  <div class="container two-column">
    <div class="column-left">
      <h3>Schedule your appointment</h3>
      <p>
        Scheduling an appointment with our team ensures expert guidance tailored to your project’s needs.
      </p>
      <img src="https://picsum.photos/600/600?random=7" alt="Schedule Appointment">
    </div>

    <div class="column-right">

      <!-- STEP 1: SELECT SERVICE -->
      <div class="booking-step step-1">
        <h4>Select Service</h4>
        <div class="service-card">
          <div><strong>Free Consultation</strong><br><small>30 minutes</small></div>
          <button class="book-btn" data-service="Free Consultation">Book</button>
        </div>
        <div class="service-card">
          <div><strong>Basic Service</strong><br><small>1 hour @ $99.00</small></div>
          <button class="book-btn" data-service="Basic Service">Book</button>
        </div>
        <div class="service-card">
          <div><strong>Advanced Service</strong><br><small>1 hour @ $199.00</small></div>
          <button class="book-btn" data-service="Advanced Service">Book</button>
        </div>
      </div>

      <!-- STEP 2: ENTER NAME + EMAIL -->
      <div class="booking-step step-2" style="display:none;">
        <button class="back-btn">←</button>
        <h4>Enter Your Info</h4>
        <form id="checkForm">
          <input type="hidden" name="service" id="step2_service">

          <label for="name">Full Name</label>
          <input type="text" id="step2_name" name="name" required>

          <label for="email">Email Address</label>
          <input type="email" id="step2_email" name="email" required>

          <button type="submit">Continue</button>
        </form>
        <div id="checkResult"></div>
      </div>

      <!-- STEP 3: SHOW CURRENT BOOKINGS -->

        <div class="booking-step step-3" style="display:none;">
        <button id="backToStep2" class="back-btn">←</button>
        <h4>Your Current Bookings</h4>
        <div id="currentBookings">Loading...</div>
        <button id="bookAnotherFrom3" class="btn" style="margin-top:1rem;">Book Another Appointment</button>
        </div>


      <!-- STEP 4: PICK DATE + TIME -->
<!-- STEP 4: PICK DATE + TIME -->
        <div class="booking-step step-4" style="display:none;">
        
        <button class="back-btn">←</button>
        <h4>Date & Time</h4>

        <div id="calendarLoading" class="loading-spinner" style="display:none;">
            <div class="spinner"></div>
            <p>Loading available dates...</p>
        </div>


        <!-- Then your service-summary and rest -->
        <div class="service-summary">Service: <span id="step4_service">...</span></div>
        <div class="toggle-view">
        <label class="switch">
            <input type="checkbox" id="toggleCustomDateSwitch">
            <span class="slider round"></span>
        </label>
        <span id="toggleLabel">Or Choose Custom Date</span>
        </div>

        <div class="date-nav">
            <button id="prevWeek">←</button>
            <div id="calendarWeek" class="week-dates"></div>
            <button id="nextWeek">→</button>
        </div>

        <div class="custom-date">
            <label for="customDate">Pick another date:</label>
            <input type="date" id="customDate">
        </div>

        <div class="time-slots" id="timeSlots">
            <p>Please select a date</p>
        </div>

        <form id="bookingForm">
            <input type="hidden" name="service" id="selectedService">
            <input type="hidden" name="date" id="selectedDate">
            <input type="hidden" name="time" id="selectedTime">
            <input type="hidden" name="name" id="selectedName">
            <input type="hidden" name="email" id="selectedEmail">

            <button type="submit" id="confirmBookingBtn" disabled>Confirm Booking</button>

        </form>

        <div id="bookingResult"></div>
        </div>


      <!-- STEP 5: THANK YOU -->
      <div class="booking-step step-5" style="display:none; text-align:center;">
        <img src="./imgs/logo-transparent-svg.svg" alt="A-1 Masonry" style="max-width:150px; margin-bottom:1rem;">
        <h3>Thank you!</h3>
        <p>Your appointment has been confirmed.<br>We will be in touch with you shortly.</p>
        <button id="bookAnotherFrom5" class="btn" style="margin-top:1.5rem;">Book Another Appointment</button>
      </div>

    </div>
  </div>
</section>

<section class="section two-column" id="about">
  <div class="container two-column">
    <div class="column-left">
      <img src="https://picsum.photos/600/600?random=8" alt="About our company" />
    </div>
    <div class="column-right">
      <h3>About Our Company</h3>
      <p>
        We pride ourselves on delivering top-tier solutions with unmatched precision and reliability.
        Our expert team is committed to providing superior construction and maintenance services to meet the needs of every project.
      </p>
      <a href="#contact" class="btn">Learn More</a>
    </div>
  </div>
</section>

<section class="section two-column" id="contact">
  <div class="container two-column">
    <div class="column-left">
      <img src="https://picsum.photos/600/600?random=9" alt="Contact us" />
    </div>
    <div class="column-right">
      <h3>Contact Us</h3>
      <p>
        Interested in working together? Fill out your info and we will be in touch shortly.
      </p>
      <form id="contactForm">
        <label for="firstName">First Name</label>
        <input type="text" id="firstName" name="firstName" required />

        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" name="lastName" />

        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />

        <label for="message">Message</label>
        <textarea id="message" name="message" rows="5" required></textarea>

        <button type="submit">Send</button>
      </form>
    </div>
  </div>
</section>


<footer>
  <div class="container footer-grid">
    <div>
      <p>Your Site Title</p>
      <p>Made with <a href="https://www.squarespace.com">Squarespace</a></p>
    </div>
    <div>
      <p>Location<br>123 Demo Street<br>New York, NY 12345</p>
    </div>
    <div>
      <p>Contact<br>email@example.com<br>(555) 555-5555</p>
    </div>
  </div>
</footer>

<script>

let availableDatesGlobal = [];

function updateBookAnotherButton() {
  const anyEditOpen = document.querySelector('.edit-form[style*="display: block"]');
  const anyCancelOpen = document.querySelector('.confirm-cancel[style*="display: block"]');
  
  const btn = document.getElementById('bookAnotherFrom3');
  
  if (anyEditOpen || anyCancelOpen) {
    btn.disabled = true;
    btn.classList.add('disabled');
  } else {
    btn.disabled = false;
    btn.classList.remove('disabled');
  }
}

document.addEventListener('DOMContentLoaded', function() {

const AVAILABLE_API = 'https://6p764d9nkl.execute-api.us-east-1.amazonaws.com/default/A1Available-dates';
const BOOKING_API   = 'https://de4igqskmj.execute-api.us-east-1.amazonaws.com/default/A1Book';
const LOOKUP_API    = 'https://de4igqskmj.execute-api.us-east-1.amazonaws.com/default/A1Book';

let currentWeekStart = new Date();

function formatDate(dateObj) {
  return dateObj.toISOString().split('T')[0];
}

function getWeekDates(start) {
  const week = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    week.push(d);
  }
  return week;
}

async function loadAvailableDates(service) {
  try {
    const response = await fetch(`${AVAILABLE_API}?service=${encodeURIComponent(service)}`);
    const data = await response.json();
    availableDatesGlobal = data.available_dates || [];
    return availableDatesGlobal;
  } catch (err) {
    console.error('Failed to load dates:', err);
    availableDatesGlobal = [];
    return [];
  }
}

function renderWeek(availableDates) {
  const week = getWeekDates(currentWeekStart);
  const calendarWeek = document.getElementById('calendarWeek');
  calendarWeek.innerHTML = '';

  week.forEach(dateObj => {
    const dateStr = formatDate(dateObj);
    const slots = availableDates.find(d => d.date === dateStr)?.slots || [];

    const dayCard = document.createElement('div');
    dayCard.className = 'day-card';
    dayCard.innerHTML = `
      <div>${dateObj.toLocaleDateString('en-US', { weekday: 'short' })}</div>
      <div>${dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
    `;

    dayCard.addEventListener('click', () => {
      document.getElementById('selectedDate').value = dateStr;
      document.querySelectorAll('.day-card').forEach(el => el.classList.remove('selected'));
      dayCard.classList.add('selected');
      renderTimeSlots(slots);
      updateConfirmButtonState();
    });

    calendarWeek.appendChild(dayCard);
  });
}

function renderTimeSlots(slots) {
  const timeSlots = document.getElementById('timeSlots');
  timeSlots.innerHTML = '';

  if (slots.length > 0) {
    slots.forEach(time => {
      const btn = document.createElement('button');
      btn.className = 'slot';
      btn.textContent = formatTime24to12(time);
      btn.addEventListener('click', () => {
        document.getElementById('selectedTime').value = time;
        document.querySelectorAll('.slot').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updateConfirmButtonState();
      });
      timeSlots.appendChild(btn);
    });
  } else {
    timeSlots.innerHTML = '<p style="text-align:center;">No appointments available</p>';
    document.getElementById('selectedTime').value = '';
    updateConfirmButtonState();
  }
}

function showStep(stepClass) {
  document.querySelectorAll('.booking-step').forEach(step => {
    step.style.display = 'none';
    step.classList.remove('active');
  });
  const stepElement = document.querySelector(stepClass);
  if (stepElement) {
    stepElement.style.display = 'flex';
    setTimeout(() => stepElement.classList.add('active'), 10);
  }
}

function formatTime24to12(timeStr) {
  if (!timeStr) {
    return 'Invalid Time';
  }

  // If timeStr already has AM/PM, just return it (cleaned)
  if (timeStr.toLowerCase().includes('am') || timeStr.toLowerCase().includes('pm')) {
    return timeStr.toUpperCase().replace(/\s+/, ' ').trim();
  }

  // Otherwise, assume it's "HH:mm"
  const [hour, minute] = timeStr.split(':').map(Number);
  if (isNaN(hour) || isNaN(minute)) {
    return 'Invalid Time';
  }

  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 || 12;
  return `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;
}




document.querySelectorAll('.book-btn').forEach(button => {
  button.addEventListener('click', function() {
    const service = this.getAttribute('data-service');
    document.getElementById('step2_service').value = service;
    showStep('.step-2');
  });
});

document.getElementById('checkForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const service = document.getElementById('step2_service').value;
  const name    = document.getElementById('step2_name').value;
  const email   = document.getElementById('step2_email').value;

  document.getElementById('selectedService').value = service;
  document.getElementById('selectedName').value    = name;
  document.getElementById('selectedEmail').value   = email;

  try {
    const response = await fetch(LOOKUP_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'lookup', service, name, email })
    });

    const result = await response.json();

    if (result.bookings && result.bookings.length > 0) {
      showStep('.step-3');

      const bookingsDiv = document.getElementById('currentBookings');
      bookingsDiv.innerHTML = '';
      result.bookings.forEach(b => {
        const [year, month, day] = b.date.split('-');
        const formattedDate = `${month}/${day}/${year}`;

        const item = document.createElement('div');
        item.className = 'booking-card';
        item.innerHTML = `
          <h5>${b.service}</h5>
          <p>${formattedDate} at ${formatTime24to12(b.time)}</p>
          <div class="booking-actions">
              <button class="edit-booking-btn" 
              data-service="${b.service}" 
              data-date="${b.date}" 
              data-time="${b.time}" 
              data-service_date_time="${b.service_date_time}"
              data-calendar_event_id="${b.calendar_event_id}">
              Edit
              </button>
              <button class="cancel-booking-btn" 
              data-service_date_time="${b.service_date_time}" 
              data-calendar_event_id="${b.calendar_event_id}">
              Cancel
              </button>
          </div>

          <div class="edit-form" style="display:none;">
              <label>New Date:
              <input type="date" class="edit-date" value="${b.date}"></label>
                <label>New Time:
                <select class="edit-time">
                    <!-- Options populated dynamically -->
                </select>
                </label>
                <div class="edit-time-loading" style="margin-top: 0.5rem; font-size: 0.9rem; color: #555; display: none;">
                    Looking for available times...
                </div>                
              <button class="save-edit-btn">Save</button>
              <button class="cancel-edit-btn">Cancel</button>
          </div>

          <div class="booking-status"></div>
          <div class="confirm-cancel" style="display:none;">
              <p>Confirm cancel?</p>
              <button class="confirm-cancel-yes">Yes</button>
              <button class="confirm-cancel-no">No</button>
          </div>
        `;
        bookingsDiv.appendChild(item);
      });

    } else {
      showStep('.step-4');
      loadStep4Dates(service);
    }

  } catch (error) {
    console.error('Lookup error:', error);
    document.getElementById('checkResult').innerText = 'Error checking bookings. Please try again.';
  }
});

document.getElementById('bookAnotherFrom3').addEventListener('click', function() {
  showStep('.step-4');
  const service = document.getElementById('selectedService').value;
  loadStep4Dates(service);
  updateBookAnotherButton();

});

document.addEventListener('click', async function(e) {

    if (e.target && e.target.classList.contains('edit-booking-btn')) {
        const card = e.target.closest('.booking-card');
        card.querySelector('.edit-form').style.display = 'block';
        card.classList.add('open-edit');
        updateBookAnotherButton();

        const editDateInput = card.querySelector('.edit-date');
        const editTimeSelect = card.querySelector('.edit-time');
        const loadingText = card.querySelector('.edit-time-loading');
        const service = card.querySelector('.edit-booking-btn').getAttribute('data-service');

            // show loading
        loadingText.style.display = 'block';

        // === First, load dates for this service
        loadAvailableDates(service).then(() => {
            const selectedDate = editDateInput.value;
            const availableSlots = availableDatesGlobal.find(d => d.date === selectedDate)?.slots || [];

            editTimeSelect.innerHTML = '';

            if (availableSlots.length > 0) {
                availableSlots.forEach(timeStr => {
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = formatTime24to12(timeStr); // user sees 12h format
                    editTimeSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No available times';
                editTimeSelect.appendChild(option);
            }
            // hide loading after populating dropdown
            loadingText.style.display = 'none';            
        });

        // === Update dropdown when user changes date
        editDateInput.addEventListener('change', () => {
            const newDate = editDateInput.value;
            const availableSlots = availableDatesGlobal.find(d => d.date === newDate)?.slots || [];

            editTimeSelect.innerHTML = '';

            if (availableSlots.length > 0) {
                availableSlots.forEach(timeStr => {
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = formatTime24to12(timeStr);
                    editTimeSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No available times';
                editTimeSelect.appendChild(option);
            }
        });
    }



  if (e.target && e.target.classList.contains('cancel-edit-btn')) {
    const card = e.target.closest('.booking-card');
    card.querySelector('.edit-form').style.display = 'none';
    card.classList.remove('open-edit');
    updateBookAnotherButton();
  }

  if (e.target && e.target.classList.contains('save-edit-btn')) {
    const card = e.target.closest('.booking-card');
    const newDate = card.querySelector('.edit-date').value;
    const newTime = card.querySelector('.edit-time').value;

    const sdt = card.querySelector('.edit-booking-btn').getAttribute('data-service_date_time');
    const service = card.querySelector('.edit-booking-btn').getAttribute('data-service');

    fetch(BOOKING_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'update',
        old_service_date_time: sdt,
        old_calendar_event_id: card.querySelector('.edit-booking-btn').getAttribute('data-calendar_event_id'),
        service: service,
        date: newDate,
        time: newTime,
        email: document.getElementById('selectedEmail').value,
        name: document.getElementById('selectedName').value
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.error) {
        card.querySelector('.booking-status').innerText = result.error;
      } else {
        card.querySelector('.booking-status').innerText = result.message || 'Booking updated!';
        card.querySelector('.edit-form').style.display = 'none';
        card.classList.remove('open-edit');
        updateBookAnotherButton();

      }
    })
    .catch(error => {
      console.error('Update error:', error);
      card.querySelector('.booking-status').innerText = 'Error updating booking.';
    });
  }

  if (e.target && e.target.classList.contains('cancel-booking-btn')) {
    const card = e.target.closest('.booking-card');
    card.querySelector('.confirm-cancel').style.display = 'block';
    updateBookAnotherButton();

  }

  if (e.target && e.target.classList.contains('confirm-cancel-no')) {
    const confirmBox = e.target.closest('.confirm-cancel');
    confirmBox.style.display = 'none';
    updateBookAnotherButton();
  }

  if (e.target && e.target.classList.contains('confirm-cancel-yes')) {
    const card = e.target.closest('.booking-card');
    const sdt  = card.querySelector('.cancel-booking-btn').getAttribute('data-service_date_time');

    fetch(BOOKING_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'cancel',
        service_date_time: sdt,
        email: document.getElementById('selectedEmail').value,
        calendar_event_id: card.querySelector('.cancel-booking-btn').getAttribute('data-calendar_event_id')
      })
    })
    .then(response => response.json())
    .then(cancelResult => {
      card.querySelector('.booking-status').innerText = cancelResult.message || 'Booking cancelled!';
      card.querySelector('.confirm-cancel').style.display = 'none';
      updateBookAnotherButton();
    })
    .catch(error => {
      console.error('Cancel error:', error);
      card.querySelector('.booking-status').innerText = 'Error cancelling booking.';
    });
  }
});

function loadStep4Dates(service) {
  document.getElementById('step4_service').textContent = service;
  currentWeekStart = new Date();

  const loadingSpinner = document.getElementById('calendarLoading');
  loadingSpinner.style.display = 'flex';

  document.getElementById('calendarWeek').innerHTML = '';
  document.getElementById('timeSlots').innerHTML = '<p>Please select a date</p>';
  document.getElementById('selectedDate').value = '';
  document.getElementById('selectedTime').value = '';
  updateConfirmButtonState();

  loadAvailableDates(service).then(availableDates => {
    renderWeek(availableDates);
    loadingSpinner.style.display = 'none';
  });

  document.getElementById('prevWeek').onclick = () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    loadingSpinner.style.display = 'flex';
    loadAvailableDates(service).then(availableDates => {
      renderWeek(availableDates);
      loadingSpinner.style.display = 'none';
    });
  };

  document.getElementById('nextWeek').onclick = () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    loadingSpinner.style.display = 'flex';
    loadAvailableDates(service).then(availableDates => {
      renderWeek(availableDates);
      loadingSpinner.style.display = 'none';
    });
  };

  document.getElementById('customDate').onchange = function() {
    document.getElementById('selectedDate').value = this.value;
    document.querySelectorAll('.day-card').forEach(el => el.classList.remove('selected'));

    const slots = availableDatesGlobal.find(d => d.date === this.value)?.slots || [];
    renderTimeSlots(slots);
    updateConfirmButtonState();
  };

  // === Restore toggle switch behavior ===
  const toggleSwitch = document.getElementById('toggleCustomDateSwitch');
  const toggleLabel = document.getElementById('toggleLabel');
  const calendarSection = document.querySelector('.date-nav');
  const customDateSection = document.querySelector('.custom-date');

  toggleSwitch.checked = false;
  customDateSection.style.display = 'none';
  calendarSection.style.display = 'flex';

  toggleSwitch.onchange = () => {
    if (toggleSwitch.checked) {
      customDateSection.style.display = 'block';
      calendarSection.style.display = 'none';
      toggleLabel.textContent = 'Back to Week View';
    } else {
      customDateSection.style.display = 'none';
      calendarSection.style.display = 'flex';
      toggleLabel.textContent = 'Choose Custom Date';
    }
  };
}


document.getElementById('bookingForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  try {
    const response = await fetch(BOOKING_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    showStep('.step-5');

  } catch (error) {
    console.error('Booking error:', error);
    document.getElementById('bookingResult').innerText = 'Error submitting booking. Please try again later.';
  }
});

document.getElementById('backToStep2').addEventListener('click', function() {
  showStep('.step-2');
});

document.getElementById('bookAnotherFrom5').addEventListener('click', function() {
  showStep('.step-1');
  updateBookAnotherButton();

});

document.querySelector('.step-2 .back-btn').addEventListener('click', function() {
  showStep('.step-1');
});

document.querySelector('.step-4 .back-btn').addEventListener('click', function() {
  showStep('.step-2');
});

function updateConfirmButtonState() {
  const dateSelected = document.getElementById('selectedDate').value;
  const timeSelected = document.getElementById('selectedTime').value;
  const confirmButton = document.getElementById('confirmBookingBtn');

  confirmButton.disabled = !(dateSelected && timeSelected);
}

});


</script>






</body>
</html>
